---
title: 1. åŸºç¡€APIä¸CLI
date: 2021-06-01
tags:
 - node
categories:
 - node
sidebar: 'auto'
---

::: tip
**æœ¬èŠ‚é‡ç‚¹**
- å¼‚æ­¥I/Oæ¦‚å¿µã€promisifyç”¨æ³•ã€æµã€buffer
- ä¸€ä¸ªç®€å•httpæœåŠ¡ï¼ˆé¡µé¢ã€jsonæ•°æ®ã€é™æ€èµ„æºï¼‰
- å®æˆ˜ä¸€ä¸ªcliå·¥å…·(vueè·¯ç”±çº¦å®š)
:::

## I/Oå¤„ç†
### å¼‚æ­¥éé˜»å¡I/O
#### **å“æ°´å£¶**  
éš”å£ç‹å¤§çˆ·æœ‰ä¸ªæ°´å£¶ï¼Œç‹å¤§çˆ·ç»å¸¸ç”¨å®ƒæ¥çƒ§å¼€æ°´ã€‚
ç‹å¤§çˆ·æŠŠæ°´å£¶æ”¾åˆ°ç«ä¸Šçƒ§ï¼Œç„¶åå•¥ä¹Ÿä¸å¹²åœ¨é‚£ç­‰ï¼Œç›´åˆ°æ°´å¼€äº†ç‹å¤§çˆ·å†å»æåˆ«çš„äº‹æƒ…ã€‚**ï¼ˆåŒæ­¥é˜»å¡ï¼‰**

ç‹å¤§çˆ·è§‰å¾—è‡ªå·±æœ‰ç‚¹æ†¨ï¼Œä¸æ‰“ç®—ç­‰äº†ã€‚æŠŠæ°´å£¶æ”¾ä¸Šå»ä¹‹åå¤§çˆ·å°±æ˜¯å»çœ‹ç”µè§†ï¼Œæ—¶ä¸æ—¶æ¥ç…ä¸€çœ¼æœ‰æ²¡æœ‰å¼€
**ï¼ˆåŒæ­¥éé˜»å¡ï¼‰**

ç‹å¤§çˆ·å»ä¹°äº†ä¸ªå“æ°´å£¶ï¼Œä»–æŠŠå“æ°´å£¶æ”¾åœ¨ç«ä¸Šï¼Œç„¶åä¹Ÿæ˜¯ç­‰ç€æ°´å¼€ï¼Œæ°´å¼€çš„æ—¶å€™æ°´å£¶ä¼šå‘å‡ºå£°å“ **ï¼ˆå¼‚æ­¥é˜»å¡ï¼‰**

ç‹å¤§çˆ·åˆè§‰å¾—è‡ªå·±æœ‰ç‚¹æ†¨ï¼Œä»–æŠŠå“æ°´å£¶æ”¾åœ¨ç«ä¸Šç„¶åå»çœ‹ç”µè§†ï¼Œè¿™æ—¶ä»–ä¸ç”¨æ˜¯ä¸æ˜¯æ¥ç…ä¸€çœ¼ï¼Œå› ä¸ºæ°´å¼€
çš„æ—¶å€™æ°´å£¶ä¼šå‘å‡ºå£°éŸ³é€šçŸ¥å¤§çˆ·ã€‚**ï¼ˆå¼‚æ­¥éé˜»å¡ï¼‰**

ä¸Šé¢å››ä¸ªæ —å­é‡Œï¼Œ**é˜»å¡éé˜»å¡**è¯´æ˜çš„æ˜¯å¤§çˆ·çš„çŠ¶æ€ï¼Œ**åŒæ­¥éåŒæ­¥**è¯´æ˜çš„æ˜¯æ°´å£¶çš„è°ƒç”¨å§¿åŠ¿ã€‚æ°´å£¶èƒ½åœ¨çƒ§
å¥½çš„æ—¶å€™ä¸»åŠ¨å“èµ·ï¼Œå°±ç­‰åŒäºæˆ‘ä»¬å¼‚æ­¥çš„å®šä¹‰ï¼Œèƒ½åœ¨ç»“æŸæ—¶é€šçŸ¥ä¸»çº¿ç¨‹å¹¶ä¸”å›è°ƒã€‚æ‰€ä»¥ **å¼‚æ­¥ä¸€èˆ¬é…åˆéé˜»å¡ï¼Œæ‰èƒ½å‘æŒ¥å…¶ä½œç”¨ã€‚**

```js
// 03-fs.js
const fs = require('fs');
// åŒæ­¥è°ƒç”¨
const data = fs.readFileSync('./conf.js'); //ä»£ç ä¼šé˜»å¡åœ¨è¿™é‡Œ
console.log(data);
// å¼‚æ­¥è°ƒç”¨
fs.readFile('./conf.js', (err, data) => {
    if (err) throw err;
    console.log(data);
})
// promisify
const {promisify} = require('util')
const readFile = promisify(fs.readFile)
readFile('./conf.js').then(data=>console.log(data))

// fs Promises API node v10
const fsp = require("fs").promises;
fsp
  .readFile("./confs.js")
  .then(data => console.log(data))
  .catch(err => console.log(err));

// async/await
(async () => {
  const fs = require('fs')
  const { promisify } = require('util')
  const readFile = promisify(fs.readFile)
  const data = await readFile('./index.html')
  console.log('data',data)
})()

// å¼•ç”¨æ–¹å¼
Buffer.from(data).toString('utf-8')
```

## Bufferç¼“å†²åŒº
> è¯»å–æ•°æ®ç±»å‹ä¸ºBuffer

  - Buffer - ç”¨äºåœ¨ TCP æµã€æ–‡ä»¶ç³»ç»Ÿæ“ä½œã€ä»¥åŠå…¶ä»–ä¸Šä¸‹æ–‡ä¸­ä¸å…«ä½å­—èŠ‚æµè¿›è¡Œäº¤äº’ã€‚ å…«ä½å­—èŠ‚ç»„æˆçš„æ•°ç»„ï¼Œå¯ä»¥æœ‰æ•ˆçš„åœ¨JSä¸­å­˜å‚¨äºŒè¿›åˆ¶æ•°æ®
```js
// 04-buffer.js
// åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º10å­—èŠ‚ä»¥0å¡«å……çš„Buffer
const buf1 = Buffer.alloc(10);
console.log(buf1);

// åˆ›å»ºä¸€ä¸ªBufferåŒ…å«ascii.
// ascii æŸ¥è¯¢ http://ascii.911cha.com/
const buf2 = Buffer.from('a')
console.log(buf2,buf2.toString())

// åˆ›å»ºBufferåŒ…å«UTF-8å­—èŠ‚
// UFT-8ï¼šä¸€ç§å˜é•¿çš„ç¼–ç æ–¹æ¡ˆï¼Œä½¿ç”¨ 1~6 ä¸ªå­—èŠ‚æ¥å­˜å‚¨ï¼›
// UFT-32ï¼šä¸€ç§å›ºå®šé•¿åº¦çš„ç¼–ç æ–¹æ¡ˆï¼Œä¸ç®¡å­—ç¬¦ç¼–å·å¤§å°ï¼Œå§‹ç»ˆä½¿ç”¨ 4 ä¸ªå­—èŠ‚æ¥å­˜å‚¨ï¼›
// UTF-16ï¼šä»‹äº UTF-8 å’Œ UTF-32 ä¹‹é—´ï¼Œä½¿ç”¨ 2 ä¸ªæˆ–è€… 4 ä¸ªå­—èŠ‚æ¥å­˜å‚¨ï¼Œé•¿åº¦æ—¢å›ºå®šåˆå¯å˜ã€‚
const buf3 = Buffer.from('Bufferåˆ›å»ºæ–¹æ³•');
console.log(buf3);

// å†™å…¥Bufferæ•°æ®
buf1.write('hello');
console.log(buf1);

// è¯»å–Bufferæ•°æ®
console.log(buf3.toString());

// åˆå¹¶Buffer
const buf4 = Buffer.concat([buf1, buf3]);
console.log(buf4.toString());
// å¯ä»¥å°è¯•ä¿®æ”¹fsæ¡ˆä¾‹è¾“å‡ºæ–‡ä»¶åŸå§‹å†…å®¹
```
> Bufferç±»ä¼¼æ•°ç»„ï¼Œæ‰€ä»¥å¾ˆå¤šæ•°ç»„æ–¹æ³•å®ƒéƒ½æœ‰ GBK è½¬ç  iconv-lite

## httpæœåŠ¡
åˆ›å»ºä¸€ä¸ªhttpæœåŠ¡å™¨ï¼Œ05-http.js

```js
const http = require('http');
const server = http.createServer((request, response) => {
  console.log('there is a request');
  response.end('a response from server');
});
server.listen(3000);
```

```js
// æ‰“å°åŸå‹é“¾
function getPrototypeChain(obj) {
  var protoChain = [];
  while (obj = Object.getPrototypeOf(obj)) {//è¿”å›ç»™å®šå¯¹è±¡çš„åŸå‹ã€‚å¦‚æœæ²¡æœ‰ç»§æ‰¿å±æ€§ï¼Œåˆ™è¿”å› null ã€‚
    protoChain.push(obj);
  }
  protoChain.push(null);
  return protoChain;
}
```
#### æ˜¾ç¤ºä¸€ä¸ªé¦–é¡µ
```js
const {url, method} = request;
if (url === '/' && method === 'GET') {
  fs.readFile('index.html', (err, data) => {
    if (err) {
      response.writeHead(500, { 'Content-Type': 'text/plain;charset=utf-8' });
      response.end('500ï¼ŒæœåŠ¡å™¨é”™è¯¯');
      return ;
    }
    response.statusCode = 200;
    response.setHeader('Content-Type', 'text/html');
    response.end(data);
  });
} else {
  response.statusCode = 404;
  response.setHeader('Content-Type', 'text/plain;charset=utf-8');
  response.end('404, é¡µé¢æ²¡æœ‰æ‰¾åˆ°');
}
```
#### ç¼–å†™ä¸€ä¸ªæ¥å£
```js
...
else if (url === '/users' && method === 'GET') {
  response.writeHead(200, { 'Content-Type': 'application/json' });
  response.end(JSON.stringify([{name:'tom',age:20}]));
}
```
## Streamæµ
stream - æ˜¯ç”¨äºä¸nodeä¸­æµæ•°æ®äº¤äº’çš„æ¥å£
```js
//äºŒè¿›åˆ¶å‹å¥½ï¼Œå›¾ç‰‡æ“ä½œ,06-stream.js
const fs = require('fs')
const rs2 = fs.createReadStream('./01.jpg')
const ws2 = fs.createWriteStream('./02.jpg')
rs2.pipe(ws2);

//å“åº”å›¾ç‰‡è¯·æ±‚ï¼Œ05-http.js
const {url, method, headers} = request;

...
else if (method === 'GET' && headers.accept.indexOf('image/*') !== -1) {
  fs.createReadStream('.'+url).pipe(response);
}
```
> Acceptä»£è¡¨å‘é€ç«¯ï¼ˆå®¢æˆ·ç«¯ï¼‰å¸Œæœ›æ¥å—çš„æ•°æ®ç±»å‹ã€‚ æ¯”å¦‚ï¼šAcceptï¼štext/xml; ä»£è¡¨å®¢æˆ·ç«¯å¸Œæœ›æ¥å—çš„æ•°æ®ç±»å‹æ˜¯xmlç±»å‹ã€‚  
Content-Typeä»£è¡¨å‘é€ç«¯ï¼ˆå®¢æˆ·ç«¯|æœåŠ¡å™¨ï¼‰å‘é€çš„å®ä½“æ•°æ®çš„æ•°æ®ç±»å‹ã€‚ æ¯”å¦‚ï¼šContentTypeï¼štext/html; ä»£è¡¨å‘é€ç«¯å‘é€çš„æ•°æ®æ ¼å¼æ˜¯htmlã€‚   
äºŒè€…åˆèµ·æ¥ï¼Œ Accept:text/xmlï¼› Content-Type:text/html ï¼Œå³ä»£è¡¨å¸Œæœ›æ¥å—çš„æ•°æ®ç±»å‹æ˜¯xmlæ ¼å¼ï¼Œæœ¬æ¬¡è¯·æ±‚å‘é€çš„æ•°æ®çš„æ•°æ®æ ¼å¼æ˜¯htmlã€‚  


## CLIå·¥å…·
### åˆ›å»ºå·¥ç¨‹
```bash
mkdir vue-auto-router-cli
cd vue-auto-router-cli
npm init -y
npm i commander download-git-repo ora handlebars figlet clear chalk open -s
```

```bash
# bin/kkb.js
#æŒ‡å®šè„šæœ¬è§£é‡Šå™¨ä¸ºnode
#!/usr/bin/env node
console.log('cli.....')

# package.json
"bin": {
  "kkb": "./bin/kkb.js"
},

# å°†npm æ¨¡å—é“¾æ¥åˆ°å¯¹åº”çš„è¿è¡Œé¡¹ç›®ä¸­å»
npm link

# åˆ é™¤çš„æƒ…å†µ
ls /usr/local/bin/
rm /usr/local/bin/kkb
```
### å®šåˆ¶å‘½ä»¤è¡Œç•Œé¢
> commander.js
**kkb.jsæ–‡ä»¶**
```js
#!/usr/bin/env node
const program = require('commander')
program.version(require('../package').version)
program
  .command('init <name>')
  .description('init project')
  .action(name => {
    console.log('init ' + name)
  })
program.parse(process.argv)
```
### æ‰“å°æ¬¢è¿ç•Œé¢
/lib/init.js
```js
const {promisify} = require('util')
const figlet = promisify(require('figlet'))
const clear = require('clear')
const chalk = require('chalk')
const log = content => console.log(chalk.green(content))
module.exports = async name => {
  // æ‰“å°æ¬¢è¿ç”»é¢
  clear()
  const data = await figlet('KKB Welcome')
  log(data)
}
```

```js
// bin/kkb.js
program
  .command('init <name>')
  .description('init project')
  .action(require('../lib/init'))
```

### å…‹éš†è„šæ‰‹æ¶
**/lib/download.js**
```js
const {promisify} = require('util')
module.exports.clone = async function(repo,desc) {
  const download = promisify(require('download-git-repo'))
  const ora = require('ora')
  const process = ora(`ä¸‹è½½.....${repo}`)
  process.start()
  await download(repo, desc)
  process.succeed()
}
```
**/lib/init.js**
```js
const {clone} = require('./download')
module.exports.init = async name => {
  // console.log('init ' + name)
  log('ğŸš€åˆ›å»ºé¡¹ç›®:' + name)
  // ä»githubå…‹éš†é¡¹ç›®åˆ°æŒ‡å®šæ–‡ä»¶å¤¹
  await clone('github:su37josephxia/vue-template', name)
}
```

### å®‰è£…ä¾èµ–
```js
// promisiyåŒ–spawn
// å¯¹æ¥è¾“å‡ºæµ
const spawn = async (...args) => {
  const { spawn } = require('child_process');
  return new Promise(resolve => {
    const proc = spawn(...args)
    proc.stdout.pipe(process.stdout)
    proc.stderr.pipe(process.stderr)
    proc.on('close', () => {
      resolve()
    })
  })
}
module.exports.init = async name => {
  // ....
  log('å®‰è£…ä¾èµ–')
  await spawn('cnpm', ['install'], { cwd: `./${name}` })
  log(chalk.green(`
    ğŸ‘Œå®‰è£…å®Œæˆï¼š
    To get Start:
    ===========================
    cd ${name}
    npm run serve
    =========================== 
  `))
}
```
### å¯åŠ¨é¡¹ç›®
```js
const open = require("open")
module.exports.init = async name => {
  // ...
  // æ‰“å¼€æµè§ˆå™¨
  open(`http://localhost:8080`);
  await spawn('npm', ['run', 'serve'], { cwd: `./${name}` })
}
```

### çº¦å®šè·¯ç”±åŠŸèƒ½
  - loader æ–‡ä»¶æ‰«æ
  - ä»£ç æ¨¡æ¿æ¸²æŸ“ hbs Mustacheé£æ ¼æ¨¡æ¿

**/lib/refresh.js**
```js
const fs = require('fs')
const handlebars = require('handlebars')
const chalk = require('chalk')
module.exports = async () => {
  // è·å–é¡µé¢åˆ—è¡¨
  const list = fs.readdirSync('./src/views')
    .filter(v => v !== 'Home.vue')
    .map(v => ({
      name: v.replace('.vue', '').toLowerCase(),
      file: v
    }))

  // ç”Ÿæˆè·¯ç”±å®šä¹‰
  compile({list}, './src/router.js', './template/router.js.hbs')

  // ç”Ÿæˆèœå•
  compile({list}, './src/App.vue', './template/App.vue.hbs')

  /**
  * ç¼–è¯‘æ¨¡æ¿æ–‡ä»¶
  * @param meta æ•°æ®å®šä¹‰
  * @param filePath ç›®æ ‡æ–‡ä»¶è·¯å¾„
  * @param templatePath æ¨¡æ¿æ–‡ä»¶è·¯å¾„
  */
  function compile(meta, filePath, templatePath) {
    if (fs.existsSync(templatePath)) {
      const content = fs.readFileSync(templatePath).toString();
      const result = handlebars.compile(content)(meta);
      fs.writeFileSync(filePath, result);
    }
    console.log(chalk.green(`ğŸš€${filePath} åˆ›å»ºæˆåŠŸ`))
  }
}
```
**/bin/kkb**
```js
program
  .command('refresh')
  .description('refresh routers...')
  .action(require('../lib/refresh'))
```

## å‘å¸ƒnpm
```bash
#!/usr/bin/env bash
npm config get registry # æ£€æŸ¥ä»“åº“é•œåƒåº“
npm config set registry=http://registry.npmjs.org
echo 'è¯·è¿›è¡Œç™»å½•ç›¸å…³æ“ä½œï¼š'
npm login # ç™»é™†
echo "-------publishing-------"
npm publish # å‘å¸ƒ
npm config set registry=https://registry.npm.taobao.org # è®¾ç½®ä¸ºæ·˜å®é•œåƒ
echo "å‘å¸ƒå®Œæˆ"
exit
```